var app = angular.module('app', ["ngResource", 'ngCookies', 'ngRoute', 'ui.bootstrap', 'ui.select',
 'ngSanitize', 'xeditable']);

app.config(function ($httpProvider, $resourceProvider) {
  $httpProvider.defaults.xsrfCookieName = 'csrftoken';
  $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
  $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
  $resourceProvider.defaults.stripTrailingSlashes = false;
});

app.run(['$http', '$cookies', function($http, $cookies) {
  $http.defaults.headers.common['X-CSRFToken'] = $cookies['csrftoken'];
}]);

app.run(function(editableOptions) {
  editableOptions.theme = 'bs3';
});

// muestra cuanto tiempo paso desde una fecha
app.filter('moment', function() {
    return function(dateString, format) {
        return moment(dateString).format(format);
	};
});

app.config(function(uiSelectConfig) {
  uiSelectConfig.theme = 'bootstrap';
  uiSelectConfig.resetSearchInput = true;
  uiSelectConfig.appendToBody = true;
});

// rutas
app.config(function($routeProvider) {
  $routeProvider
    .when('/', {
      templateUrl : 'templates/task.html',
      controller  : 'taskController'
    })

    .when('/task/:taskId', {
      templateUrl : 'templates/detailTask.html',
      controller  : 'commentsController'
    })

    .when('/todo/', {
      templateUrl : 'templates/todo.html',
      controller  : 'todoController'
    })

    .when('/client/', {
      templateUrl : 'templates/client.html',
      controller  : 'clientController'
    })

    .when('/2/', {
      templateUrl : 'templates/task2.html',
      controller  : 'taskController'
    })

    .when('/3/', {
      templateUrl : 'templates/task3.html',
      controller  : 'taskController'
    })

    .otherwise({
      redirectTo: '/'
    });
});

// directiva para calendario
app.directive('jqdatepicker', function () {
    return {
        restrict: 'A',
        require: 'ngModel',
         link: function (scope, element, attrs, ngModelCtrl) {
            element.datepicker({
                dateFormat: 'yy-mm-dd',
                onSelect: function (date) {
                    scope.date = date;
                    scope.$apply();
                }
            });
        }
    };
});

// Factoriza los resource para obtener datos de la api de django
app.factory('taskResource', function ($resource) {
  return $resource('/task/:id', {id:'@id'},
    {
      'get':    {method:'GET', isArray:false},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'} 
    });
});

app.factory('organizationResource', function ($resource) {
  return $resource('/organization/:id', {id:'@id'},
    {
      'get':    {method:'GET', isArray:false},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'} 
    });
});

app.factory('notificationResource', function ($resource) {
  return $resource('/notification/:id', {id:'@id'},
    {
      'get':    {method:'GET'},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'},
      'markAsRead': { method: 'POST', isArray: true }
    });
});

app.factory('taskCommentsResource', function ($resource) {
  return $resource('/taskComment/:id', {id:'@id'},
    {
      'get':    {method:'GET'},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'} 
    });
});

app.factory('taskCommentsResource2', function ($resource) {
  return $resource('/taskComment2/:id', {id:'@id'},
    {
      'get':    {method:'GET'},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'} 
    });
});

app.factory('clientResource', function ($resource) {
  return $resource('/client/:id', {id:'@id'},
    {
      'get':    {method:'GET'},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'} 
    });
});

app.factory('todoResource', function ($resource) {
  return $resource('/todo/:id', {id:'@id'},
    {
      'get':    {method:'GET'},
      'save':   {method:'POST'},
      'update': {method:'PUT'},
      'query':  {method:'GET', isArray:true},
      'remove': {method:'DELETE'},
      'delete': {method:'DELETE'} 
    });
});

app.controller('taskController', function ($scope, taskResource) {
  // obtiene las tareas
  function getTasks() {
    $scope.tasks = taskResource.query({done: false});
    $scope.ctasks = taskResource.query({done: true});
  }
  getTasks();

  // marca como realizada la tarea
  $scope.doneTask = function(taskId) {
    taskResource.get({ taskId:taskId }, function(task) {
      task.done = true;
      taskResource.update({ taskId:task.id }, task);
    });
    getTasks();
  };

  // borra la tarea
  $scope.deleteTask = function(taskId) {
    taskResource.delete({ taskId : taskId });
    getTasks();
  };
})

app.controller('modalController', function ($scope, taskResource, clientResource) {
  // carga select con clientes
  clientResource.query({}, function(data){
    $scope.clients = data;
  });

  // crea tarea
  $scope.newTask = function() {
    $scope.task.user = 1;
    taskResource.save($scope.task);
  };
})

app.controller('commentsController', function ($scope, taskCommentsResource, $routeParams, taskResource, 
  notificationResource, taskCommentsResource2, $timeout) {
  // numero de pagina inicial para paginador
  $scope.currentPage = 1;

  // obtiene el id de la tarea desde la url y la convierte a int
  var taskId = parseInt($routeParams.taskId, 10);

  // obtiene comentarios de la tarea seleccionada
  function getComments(){
   taskCommentsResource.get({ task : taskId }, function(data){
      $scope.allComments = data.results;    
      $scope.totalItems = data.count;
    })
  };
  getComments();

  // cuando cambia la pagina , setea numero de pagina en la consulta y actualiza los resultados
  $scope.pageChanged = function() {
    taskCommentsResource.get({ task : taskId , page : $scope.currentPage}, function(data){
      $scope.allComments = data.results;    
    })
  };

  // crea nuevo comentario
  $scope.newComment = function () {
    var cm = new taskCommentsResource2;
    cm.task = taskId;
    cm.user = 1;
    cm.comment = $scope.cm.comment;
    cm.$save();

    // notifica al usuario
    var nt = new notificationResource;
    nt.user = 1;
    nt.ntype = "comment";
    nt.notification = taskId;
    nt.$save();
    $timeout(getComments, 500);
  }

  // obtengo tarea actual
  cTask = taskResource.get({ id : taskId }, function(task){
    $scope.task = task;   
  });

  // actualiza tarea actual
  $scope.updateTask = function(){
    cTask = $scope.task;
    cTask.$update();
  };
})

app.controller('mainController', function ($scope, notificationResource, $timeout) {
  // obtiene todas las notificaciones
  getAllNotifications = function() {
    notificationResource.get({read: 'False'}, function(data){
      $scope.countNotification = data.count;
      $scope.notifications = data.results;
    });
  };
  getAllNotifications();

  // marca todas como leidas
  $scope.markAsRead = function(all){
    all.forEach(function(data) {
      data.read = true;
      notificationResource.update({id : data.id}, data);
    });
    $timeout(getAllNotifications, 500);
  };
})

app.controller('todoController', function ($scope, todoResource, $timeout) {
  // lista de mis tareas
  getTodoTask = function() {
    todoResource.query({user: 1}, function(data){
      $scope.todoTasks = data;
    });
  };
  getTodoTask();

  // agrega tarea al usuario
  $scope.addTodo = function () {
    var td = new todoResource;
    td.description = $scope.description;
    td.user = 1;
    td.$save();
    $timeout(getTodoTask, 500);
  }

  // borra tarea al usuario
  $scope.deleteTodo = function (todoId) {
    todoResource.get({id: todoId}, function(data){
      todoResource.delete({id : data.id});
      $timeout(getTodoTask, 500);
    });
  }

  // marca tarea como realizada
  $scope.doneTodo = function (todoId) {
    var td = todoResource.get({id : todoId}, function(data){
      var td = data;
      td.done = !td.done;
      td.$update();
      $timeout(getTodoTask, 500);
    });
  }
})

app.controller('clientController', function ($scope, clientResource, organizationResource) {
  // organizacion seleccionada
  $scope.vm = {
    selectedOrg : null
  };
  
  // setea organizacion para filtrar
  $scope.setOrganization = function(id) {  
    $scope.org = id;
  }

  // obtiene todas las organizaciones
  getOrganizations = function() {
    organizationResource.query({}, function(data){
      $scope.organizations = data;
    });
  };
  getOrganizations();

  // obtiene todos los clientes
  getClients = function() {
    clientResource.query({}, function(data){
      $scope.clients = data;
    });
  };
  getClients();
  
  // obtiene el cliente seleccionado
  $scope.getClient = function(id) {
    clientResource.get({id}, function(data){
      $scope.client = data;
    });
  };
})